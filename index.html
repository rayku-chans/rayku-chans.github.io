<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>WebRTC P2P Demo</title>
    <style>
        textarea { width: 100%; height: 100px; }
        button { margin-top: 10px; }
    </style>
</head>
<body>
<h2>WebRTC P2P ç‚¹å¯¹ç‚¹é€šä¿¡</h2>

<div>
    <button onclick="createOffer()">åˆ›å»º Offer</button>
    <button onclick="createAnswer()">åˆ›å»º Answer</button>
    <button onclick="addRemoteDesc()">æ·»åŠ è¿œç¨‹ SDP</button>
    <button onclick="sendMessage()">å‘é€æ¶ˆæ¯</button>
</div>

<h3>æœ¬åœ° SDP</h3>
<textarea id="localSDP"></textarea>

<h3>è¿œç¨‹ SDP</h3>
<textarea id="remoteSDP"></textarea>

<h3>é€šä¿¡æ—¥å¿—</h3>
<div id="log" style="white-space: pre-line; border: 1px solid #ccc; padding: 10px;"></div>

<script>
    let pc = new RTCPeerConnection({
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' }, // å…è´¹ STUN
            // å¦‚éœ€ TURNï¼Œå¯è‡ªè¡Œæ­å»ºæˆ–ä½¿ç”¨ç¬¬ä¸‰æ–¹ï¼ˆéœ€æ”¶è´¹ï¼‰
        ]
    });
    let dataChannel;

    pc.onicecandidate = e => {
        if (e.candidate === null) {
            document.getElementById('localSDP').value = JSON.stringify(pc.localDescription);
        }
    };

    pc.ondatachannel = e => {
        dataChannel = e.channel;
        setupChannel();
    };

    function setupChannel() {
        dataChannel.onopen = () => log("âœ… é€šé“å·²æ‰“å¼€");
        dataChannel.onmessage = e => log("ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: " + e.data);
    }

    function createOffer() {
        dataChannel = pc.createDataChannel("chat");
        setupChannel();
        pc.createOffer()
            .then(d => pc.setLocalDescription(d))
            .catch(console.error);
    }

    function createAnswer() {
        let sdp = document.getElementById('remoteSDP').value;
        if (!sdp) return alert("è¯·å…ˆå¡«å†™è¿œç¨‹ SDP");

        pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(sdp)))
            .then(() => pc.createAnswer())
            .then(answer => pc.setLocalDescription(answer))
            .catch(console.error);
    }

    function addRemoteDesc() {
        let sdp = document.getElementById('remoteSDP').value;
        if (!sdp) return alert("è¯·å¡«å†™è¿œç¨‹ SDP");
        pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(sdp)))
            .catch(console.error);
    }

    function sendMessage() {
        if (!dataChannel || dataChannel.readyState !== 'open') return alert("é€šé“æœªæ‰“å¼€");
        dataChannel.send("ä½ å¥½ï¼ŒP2P ğŸ‘‹");
        log("ğŸ“¤ å·²å‘é€: ä½ å¥½ï¼ŒP2P ğŸ‘‹");
    }

    function log(msg) {
        document.getElementById('log').textContent += msg + '\n';
    }
</script>
</body>
</html>
